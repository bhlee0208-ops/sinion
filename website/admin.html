<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8" />
        <title>관리자 페이지 | 시니온(SINION)</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="시니온 관리자 페이지 - 회원관리, 입력폼관리, 공지사항 관리"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <!-- App favicon -->
        <link rel="shortcut icon" href="assets/images/fav.png">

        <!-- App css -->
        <link href="assets/admin/css/app.min.css" rel="stylesheet" type="text/css" id="app-style" />

        <!-- Icons -->
        <link href="assets/admin/css/icons.min.css" rel="stylesheet" type="text/css" />

        <script src="assets/admin/js/head.js"></script>

        <style>
            /* 로고 박스 상하 여백 추가 */
            .logo-box {
                padding-top: 30px !important;
                padding-bottom: 40px !important;
                margin-bottom: 40px !important;
            }
            .logo-box .logo {
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 10px 0;
            }
            .logo-box .logo img {
                width: auto;
                height: auto;
            }
            /* 메뉴 상단 여백 추가 */
            #side-menu {
                margin-top: 20px !important;
                padding-top: 20px !important;
            }
            #side-menu .menu-title {
                margin-top: 20px !important;
                padding-top: 20px !important;
            }
            
            /* 테이블 간격 조정 */
            .table th, .table td {
                padding: 12px 15px !important;
                vertical-align: middle;
            }
            
            .table thead th {
                border-bottom: 2px solid #dee2e6;
                font-weight: 600;
            }
            
            .table tbody tr:hover {
                background-color: #f8f9fa;
            }
            
            /* 버튼 간격 조정 */
            .btn-sm {
                padding: 6px 12px;
                font-size: 13px;
                margin: 0 2px;
            }
            
            /* 입력폼 상세 정보 스타일 */
            .form-detail-item {
                margin-bottom: 15px;
            }
            .form-detail-item .form-label {
                font-size: 14px;
                color: #6c757d;
                margin-bottom: 8px;
                display: block;
            }
            .form-detail-item .form-value {
                font-size: 16px;
                color: #212529;
                margin: 0;
                padding: 10px 0;
                border-bottom: 1px solid #e9ecef;
            }
            .form-detail-item .form-value:last-child {
                border-bottom: none;
            }
            #form-detail-card {
                border: 2px solid #e9ecef;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            #form-detail-card .card-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-bottom: none;
            }
            #form-detail-card .card-header .btn-secondary {
                background: rgba(255, 255, 255, 0.2);
                border: 1px solid rgba(255, 255, 255, 0.3);
                color: white;
            }
            #form-detail-card .card-header .btn-secondary:hover {
                background: rgba(255, 255, 255, 0.3);
            }
            
            /* 상태 드롭다운 스타일 */
            .form-select-sm {
                min-width: 100px;
                padding: 4px 8px;
                font-size: 13px;
            }
        </style>

    </head>

    <!-- body start -->
    <body data-menu-color="dark" data-sidebar="default">

        <!-- Begin page -->
        <div id="app-layout">

            <!-- Topbar Start -->
            <div class="topbar-custom">
                <div class="container-fluid">
                    <div class="d-flex justify-content-between">
                        <ul class="list-unstyled topnav-menu mb-0 d-flex align-items-center">
                            <li>
                                <button class="button-toggle-menu nav-link">
                                    <i data-feather="menu" class="noti-icon"></i>
                                </button>
                            </li>
                            <li class="d-none d-lg-block">
                                <form class="app-search d-none d-md-block me-auto" id="admin-search-form">
                                    <div class="position-relative topbar-search">
                                        <input type="text" id="admin-search-input" class="form-control ps-4" placeholder="검색..." />
                                        <iconify-icon icon="solar:minimalistic-magnifer-outline" class="align-middle fs-14 position-absolute text-muted top-50 translate-middle-y ms-2"></iconify-icon>
                                    </div>
                                </form>
                            </li>
                        </ul>

                        <ul class="list-unstyled topnav-menu mb-0 d-flex align-items-center">
                            <!-- Button Trigger Customizer Offcanvas -->
                            <li class="d-none d-sm-flex">
                                <button type="button" class="btn nav-link" data-toggle="fullscreen">
                                    <iconify-icon icon="solar:minimize-square-outline" class="fs-24 align-middle"></iconify-icon>
                                </button>
                            </li>

                            <!-- Light/Dark Mode Button Themes -->
                            <li class="d-none d-sm-flex">
                                <button type="button" class="btn nav-link" id="light-dark-mode">
                                    <iconify-icon icon="solar:moon-outline" class="fs-24 align-middle dark-mode"></iconify-icon>
                                    <iconify-icon icon="solar:sun-2-outline" class="fs-24 align-middle light-mode"></iconify-icon>
                                </button>
                            </li>

                            <!-- User Dropdown -->
                            <li class="dropdown notification-list topbar-dropdown">
                                <a class="nav-link dropdown-toggle nav-user me-0" data-bs-toggle="dropdown" href="#" role="button"
                                    aria-haspopup="false" aria-expanded="false">
                                    <img src="assets/admin/images/users/profile.jpg" alt="user-image" class="rounded-circle" />
                                </a>
                                <div class="dropdown-menu dropdown-menu-end profile-dropdown">
                                    <!-- item-->
                                    <div class="dropdown-header noti-title">
                                        <h6 class="text-overflow m-0">관리자</h6>
                                    </div>

                                    <!-- item-->
                                    <a href="index.html" class="dropdown-item notify-item rounded-2">
                                        <iconify-icon icon="solar:home-2-outline" class="fs-18 align-middle"></iconify-icon>
                                        <span>홈페이지</span>
                                    </a>

                                    <!-- item-->
                                    <a href="auth-logout.html" class="dropdown-item notify-item rounded-2">
                                        <iconify-icon icon="solar:login-3-outline" class="fs-18 align-middle"></iconify-icon>
                                        <span>로그아웃</span>
                                    </a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- end Topbar -->

            <!-- Left Sidebar Start -->
            <div class="app-sidebar-menu">
                <div class="h-100" data-simplebar>

                    <!--- Sidemenu -->
                    <div id="sidebar-menu">

                        <div class="logo-box">
                            <a href="index.html" class="logo logo-light">
                                <span class="logo-sm">
                                    <img src="assets/images/logo/logo.png" alt="시니온" height="50" style="max-height: 50px;">
                                </span>
                                <span class="logo-lg">
                                    <img src="assets/images/logo/logo.png" alt="시니온" height="80" style="max-height: 80px;">
                                </span>
                            </a>
                            <a href="index.html" class="logo logo-dark">
                                <span class="logo-sm">
                                    <img src="assets/images/logo/logo.png" alt="시니온" height="50" style="max-height: 50px;">
                                </span>
                                <span class="logo-lg">
                                    <img src="assets/images/logo/logo.png" alt="시니온" height="80" style="max-height: 80px;">
                                </span>
                            </a>
                        </div>

                        <ul id="side-menu">

                            <li class="menu-title">관리 메뉴</li>

                            <li>
                                <a href="#memberManagement" data-bs-toggle="collapse">
                                    <span class="nav-icon">
                                        <iconify-icon icon="solar:shield-user-bold-duotone"></iconify-icon>
                                    </span>
                                    <span> 회원관리 </span>
                                    <span class="menu-arrow"></span>
                                </a>
                                <div class="collapse show" id="memberManagement">
                                    <ul class="nav-second-level">
                                        <li>
                                            <a href="#member-list" class="tp-link active">회원 목록</a>
                                        </li>
                                    </ul>
                                </div>
                            </li>

                            <li>
                                <a href="#formManagement" data-bs-toggle="collapse">
                                    <span class="nav-icon">
                                        <iconify-icon icon="solar:document-add-bold-duotone"></iconify-icon>
                                    </span>
                                    <span> 입력폼관리 </span>
                                    <span class="menu-arrow"></span>
                                </a>
                                <div class="collapse" id="formManagement">
                                    <ul class="nav-second-level">
                                        <li>
                                            <a href="#form-list" class="tp-link">폼 목록</a>
                                        </li>
                                    </ul>
                                </div>
                            </li>

                            <li>
                                <a href="#noticeManagement" data-bs-toggle="collapse">
                                    <span class="nav-icon">
                                        <iconify-icon icon="solar:clipboard-text-bold-duotone"></iconify-icon>
                                    </span>
                                    <span> 공지사항 관리 </span>
                                    <span class="menu-arrow"></span>
                                </a>
                                <div class="collapse" id="noticeManagement">
                                    <ul class="nav-second-level">
                                        <li>
                                            <a href="#notice-list" class="tp-link">공지사항 목록</a>
                                        </li>
                                        <li>
                                            <a href="#notice-add" class="tp-link">공지사항 작성</a>
                                        </li>
                                    </ul>
                                </div>
                            </li>

                        </ul>
                    </div>
                    <!-- End Sidebar -->
         
                    <div class="clearfix"></div>

                </div>
            </div>
            <!-- Left Sidebar End -->

            <!-- ============================================================== -->
            <!-- Start Page Content here -->
            <!-- ============================================================== -->
        
            <div class="content-page">
                <div class="content">

                    <!-- Start Content-->
                    <div class="container-fluid">

                        <div class="py-3 d-flex align-items-sm-center flex-sm-row flex-column">
                            <div class="flex-grow-1">
                                <h4 class="fs-18 fw-semibold m-0">회원관리</h4>
                            </div>
            
                            <div class="text-end">
                                <ol class="breadcrumb m-0 py-0">
                                    <li class="breadcrumb-item"><a href="index.html">홈</a></li>
                                    <li class="breadcrumb-item active">회원관리</li>
                                </ol>
                            </div>
                        </div>

                        <!-- 회원 목록 -->
                        <div id="member-list-section" class="content-section">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">회원 목록</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th scope="col" style="width: 60px;">번호</th>
                                                            <th scope="col" style="width: 120px;">이름</th>
                                                            <th scope="col" style="width: 200px;">이메일</th>
                                                            <th scope="col" style="width: 120px;">가입일</th>
                                                            <th scope="col" style="width: 100px;">상태</th>
                                                            <th scope="col" style="width: 150px;">관리</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="member-list-tbody">
                                                        <!-- Firebase에서 데이터를 동적으로 로드합니다 -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 입력폼 목록 -->
                        <div id="form-list-section" class="content-section" style="display: none;">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5 class="card-title mb-0">입력폼 목록</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th scope="col">번호</th>
                                                            <th scope="col">폼명</th>
                                                            <th scope="col">제출자</th>
                                                            <th scope="col">제출일</th>
                                                            <th scope="col">상태</th>
                                                            <th scope="col">관리</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="form-list-tbody">
                                                        <!-- Firebase에서 데이터를 동적으로 로드합니다 -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 입력폼 상세 정보 카드 -->
                                    <div id="form-detail-card" class="card mt-4" style="display: none;">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="card-title mb-0">입력폼 상세 정보</h5>
                                            <button type="button" class="btn btn-sm btn-secondary" onclick="closeFormDetail()">
                                                <i class="fas fa-times"></i> 닫기
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div id="form-detail-content">
                                                <!-- 상세 정보가 여기에 동적으로 로드됩니다 -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 공지사항 목록 -->
                        <div id="notice-list-section" class="content-section" style="display: none;">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="card-title mb-0">공지사항 목록</h5>
                                            <button class="btn btn-primary btn-sm" onclick="showNoticeForm()" id="notice-write-btn">공지사항 작성</button>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover mb-0">
                                                    <thead>
                                                        <tr>
                                                            <th scope="col">번호</th>
                                                            <th scope="col">제목</th>
                                                            <th scope="col">작성자</th>
                                                            <th scope="col">작성일</th>
                                                            <th scope="col">조회수</th>
                                                            <th scope="col">상태</th>
                                                            <th scope="col">관리</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="notice-list-tbody">
                                                        <!-- Firebase에서 데이터를 동적으로 로드합니다 -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 공지사항 작성 폼 -->
                        <div id="notice-add-section" class="content-section" style="display: none;">
                            <div class="row">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="card-title mb-0">공지사항 작성</h5>
                                            <button class="btn btn-secondary btn-sm" onclick="showNoticeList()">목록으로</button>
                                        </div>
                                        <div class="card-body">
                                            <form id="notice-form">
                                                <div class="mb-3">
                                                    <label for="notice-title" class="form-label">제목 <span class="text-danger">*</span></label>
                                                    <input type="text" class="form-control" id="notice-title" required>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="notice-content" class="form-label">내용 <span class="text-danger">*</span></label>
                                                    <textarea class="form-control" id="notice-content" rows="10" required></textarea>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="notice-important">
                                                        <label class="form-check-label" for="notice-important">
                                                            중요 공지사항으로 설정
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="notice-published" checked>
                                                        <label class="form-check-label" for="notice-published">
                                                            즉시 공개
                                                        </label>
                                                    </div>
                                                </div>
                                                
                                                <div class="d-flex gap-2">
                                                    <button type="submit" class="btn btn-primary">작성하기</button>
                                                    <button type="button" class="btn btn-secondary" onclick="resetNoticeForm()">초기화</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- container-fluid -->

                </div> <!-- content -->

                <!-- Footer Start -->
                <footer class="footer">
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col fs-13 text-muted text-center">
                                &copy;
                                <script>document.write(new Date().getFullYear())</script> 시니온(SINION) 관리자 페이지
                            </div>
                        </div>
                    </div>
                </footer>
                <!-- end Footer -->

            </div>
            <!-- ============================================================== -->
            <!-- End Page content -->
            <!-- ============================================================== -->

        </div>
        <!-- END wrapper -->

        <!-- Vendor -->
        <script src="assets/admin/libs/jquery/jquery.min.js"></script>
        <script src="assets/admin/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/admin/libs/iconify-icon/iconify-icon.min.js"></script>
        <script src="assets/admin/libs/simplebar/simplebar.min.js"></script>
        <script src="assets/admin/libs/node-waves/waves.min.js"></script>
        <script src="assets/admin/libs/feather-icons/feather.min.js"></script>

        <!-- App js-->
        <script src="assets/admin/js/app.js"></script>


        <!-- Firebase 회원 목록 로드 -->
        <script type="module">
            import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
            import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
            import { getFirestore, collection, getDocs, query, orderBy, deleteDoc, doc, updateDoc, getDoc, Timestamp, addDoc, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
            
            const firebaseConfig = {
                apiKey: "AIzaSyBIPC1cb6Auw4JKmNbNjlvyYUwOYySvmqo",
                authDomain: "sinion-29380.firebaseapp.com",
                projectId: "sinion-29380",
                storageBucket: "sinion-29380.firebasestorage.app",
                messagingSenderId: "417218748288",
                appId: "1:417218748288:web:cce20cdeefa181c32b6b65",
                measurementId: "G-8NW54FCZ3R"
            };
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // 회원 목록 로드 함수
            async function loadMemberList() {
                try {
                    const tbody = document.getElementById('member-list-tbody');
                    if (!tbody) return;
                    
                    // 로딩 표시
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">로딩 중...</td></tr>';
                    
                    // Firestore에서 회원 목록 가져오기
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">등록된 회원이 없습니다.</td></tr>';
                        return;
                    }
                    
                    // 테이블 데이터 생성
                    let html = '';
                    let index = 1;
                    
                    querySnapshot.forEach((docSnapshot) => {
                        const userData = docSnapshot.data();
                        const docId = docSnapshot.id; // Firestore 문서 ID
                        
                        // 날짜 포맷팅
                        let createdAt = 'N/A';
                        if (userData.createdAt) {
                            const date = userData.createdAt.toDate ? userData.createdAt.toDate() : new Date(userData.createdAt);
                            createdAt = date.toLocaleDateString('ko-KR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });
                        }
                        
                        // role에 따른 상태 표시
                        const role = userData.role || 'user';
                        const roleBadge = role === 'admin' 
                            ? '<span class="badge bg-danger">관리자</span>'
                            : '<span class="badge bg-success">일반</span>';
                        
                        // 이름 이스케이프 (XSS 방지)
                        const userName = (userData.name || 'N/A').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        const userEmail = (userData.email || 'N/A').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        
                        html += `
                            <tr>
                                <th scope="row">${index}</th>
                                <td>${userData.name || 'N/A'}</td>
                                <td>${userData.email || 'N/A'}</td>
                                <td>${createdAt}</td>
                                <td>${roleBadge}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-2" onclick="editMember('${docId}', '${userName}', '${userEmail}', '${role}')">수정</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteMember('${docId}', '${userName}')">삭제</button>
                                </td>
                            </tr>
                        `;
                        index++;
                    });
                    
                    tbody.innerHTML = html;
                } catch (error) {
                    console.error('회원 목록 로드 오류:', error);
                    const tbody = document.getElementById('member-list-tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
                    }
                }
            }
            
            // 회원 삭제 함수
            window.deleteMember = async function(docId, name) {
                if (!confirm(`정말로 ${name || '이 회원'}을 삭제하시겠습니까?`)) {
                    return;
                }
                
                try {
                    await deleteDoc(doc(db, 'users', docId));
                    alert('회원이 삭제되었습니다.');
                    loadMemberList(); // 목록 새로고침
                } catch (error) {
                    console.error('회원 삭제 오류:', error);
                    alert('회원 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            };
            
            // 회원 수정 함수
            window.editMember = function(docId, currentName, currentEmail, currentRole) {
                // 모달 또는 입력 폼으로 수정
                const newName = prompt('이름을 수정하세요:', currentName);
                if (newName === null) return; // 취소
                
                const newEmail = prompt('이메일을 수정하세요:', currentEmail);
                if (newEmail === null) return; // 취소
                
                // role 선택
                const roleOptions = currentRole === 'admin' 
                    ? '1. 관리자 (현재)\n2. 일반 사용자'
                    : '1. 관리자\n2. 일반 사용자 (현재)';
                const roleChoice = prompt(`역할을 선택하세요:\n${roleOptions}`, currentRole === 'admin' ? '1' : '2');
                if (roleChoice === null) return; // 취소
                
                const newRole = roleChoice === '1' ? 'admin' : 'user';
                
                if (confirm(`다음 정보로 수정하시겠습니까?\n\n이름: ${newName}\n이메일: ${newEmail}\n역할: ${newRole === 'admin' ? '관리자' : '일반 사용자'}`)) {
                    updateMember(docId, newName, newEmail, newRole);
                }
            };
            
            // 회원 정보 업데이트 함수
            async function updateMember(docId, name, email, role) {
                try {
                    await updateDoc(doc(db, 'users', docId), {
                        name: name,
                        email: email,
                        role: role,
                        updatedAt: new Date()
                    });
                    alert('회원 정보가 수정되었습니다.');
                    loadMemberList(); // 목록 새로고침
                } catch (error) {
                    console.error('회원 수정 오류:', error);
                    alert('회원 수정 중 오류가 발생했습니다: ' + error.message);
                }
            }
            
            // 인증 상태 확인 후 데이터 로드
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // 관리자 확인 후 데이터 로드
                    loadMemberList();
                }
            });
            
            // 전역 함수로 등록
            window.loadMemberList = loadMemberList;
            
            // 입력폼 목록 로드 함수
            async function loadFormList() {
                try {
                    const tbody = document.getElementById('form-list-tbody');
                    if (!tbody) return;
                    
                    // 로딩 표시
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">로딩 중...</td></tr>';
                    
                    // Firestore에서 입력폼 목록 가져오기
                    const formsRef = collection(db, 'forms');
                    const q = query(formsRef, orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center">등록된 입력폼이 없습니다.</td></tr>';
                        return;
                    }
                    
                    // 테이블 데이터 생성
                    let html = '';
                    let index = 1;
                    
                    querySnapshot.forEach((docSnapshot) => {
                        const formData = docSnapshot.data();
                        const docId = docSnapshot.id;
                        
                        // 날짜 포맷팅
                        let createdAt = 'N/A';
                        if (formData.createdAt) {
                            const date = formData.createdAt.toDate ? formData.createdAt.toDate() : new Date(formData.createdAt);
                            createdAt = date.toLocaleDateString('ko-KR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });
                        }
                        
                        // 상태에 따른 배지
                        const status = formData.status || 'pending';
                        let statusBadge = '';
                        switch(status) {
                            case 'pending':
                                statusBadge = '<span class="badge bg-warning">대기</span>';
                                break;
                            case 'processing':
                                statusBadge = '<span class="badge bg-info">검토중</span>';
                                break;
                            case 'completed':
                                statusBadge = '<span class="badge bg-success">완료</span>';
                                break;
                            case 'rejected':
                                statusBadge = '<span class="badge bg-danger">거절</span>';
                                break;
                            default:
                                statusBadge = '<span class="badge bg-secondary">대기</span>';
                        }
                        
                        // 폼 타입에 따른 이름
                        const formType = formData.type || 'education';
                        const formName = formType === 'education' ? '교육신청서' : '문의하기';
                        
                        // 이름 이스케이프 (XSS 방지)
                        const submitterName = (formData.name || 'N/A').replace(/'/g, "&#39;").replace(/"/g, "&quot;");
                        
                        // 상태 변경 드롭다운
                        const statusDropdown = `
                            <select class="form-select form-select-sm" onchange="changeFormStatus('${docId}', this.value)" style="width: auto; display: inline-block;">
                                <option value="pending" ${status === 'pending' ? 'selected' : ''}>대기</option>
                                <option value="completed" ${status === 'completed' ? 'selected' : ''}>완료</option>
                            </select>
                        `;
                        
                        html += `
                            <tr>
                                <th scope="row">${index}</th>
                                <td>${formName}</td>
                                <td>${formData.name || 'N/A'}</td>
                                <td>${createdAt}</td>
                                <td>${statusDropdown}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-2" onclick="viewForm('${docId}')">보기</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteForm('${docId}', '${submitterName}')">삭제</button>
                                </td>
                            </tr>
                        `;
                        index++;
                    });
                    
                    tbody.innerHTML = html;
                } catch (error) {
                    console.error('입력폼 목록 로드 오류:', error);
                    const tbody = document.getElementById('form-list-tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
                    }
                }
            }
            
            // 입력폼 보기 함수
            window.viewForm = async function(docId) {
                try {
                    const docRef = doc(db, 'forms', docId);
                    const docSnap = await getDoc(docRef);
                    
                    if (!docSnap.exists()) {
                        alert('입력폼을 찾을 수 없습니다.');
                        return;
                    }
                    
                    const formData = docSnap.data();
                    
                    // 날짜 포맷팅
                    let createdAt = 'N/A';
                    if (formData.createdAt) {
                        const date = formData.createdAt.toDate ? formData.createdAt.toDate() : new Date(formData.createdAt);
                        createdAt = date.toLocaleString('ko-KR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    
                    // 상태 배지
                    const status = formData.status || 'pending';
                    let statusBadge = '';
                    switch(status) {
                        case 'pending':
                            statusBadge = '<span class="badge bg-warning">대기</span>';
                            break;
                        case 'processing':
                            statusBadge = '<span class="badge bg-info">검토중</span>';
                            break;
                        case 'completed':
                            statusBadge = '<span class="badge bg-success">완료</span>';
                            break;
                        case 'rejected':
                            statusBadge = '<span class="badge bg-danger">거절</span>';
                            break;
                        default:
                            statusBadge = '<span class="badge bg-secondary">대기</span>';
                    }
                    
                    // 상세 정보 HTML 생성
                    const detailContent = `
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">폼 타입</label>
                                    <p class="form-value">${formData.type === 'education' ? '교육신청서' : '문의하기'}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">상태</label>
                                    <p class="form-value">${statusBadge}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">이름</label>
                                    <p class="form-value">${formData.name || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">연락처</label>
                                    <p class="form-value">${formData.phone || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">이메일</label>
                                    <p class="form-value">${formData.email || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">제출일</label>
                                    <p class="form-value">${createdAt}</p>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">주소</label>
                                    <p class="form-value">${formData.address || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">제목</label>
                                    <p class="form-value">${formData.subject || 'N/A'}</p>
                                </div>
                            </div>
                            <div class="col-12 mb-3">
                                <div class="form-detail-item">
                                    <label class="form-label fw-semibold">내용</label>
                                    <div class="form-value" style="background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap; min-height: 100px;">${formData.content || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // 상세 정보 카드 표시
                    const detailCard = document.getElementById('form-detail-card');
                    const detailContentDiv = document.getElementById('form-detail-content');
                    
                    if (detailCard && detailContentDiv) {
                        detailContentDiv.innerHTML = detailContent;
                        detailCard.style.display = 'block';
                        
                        // 스크롤을 상세 정보 카드로 이동
                        setTimeout(() => {
                            detailCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                } catch (error) {
                    console.error('입력폼 보기 오류:', error);
                    alert('입력폼을 불러오는 중 오류가 발생했습니다: ' + error.message);
                }
            };
            
            // 입력폼 상세 정보 닫기 함수
            window.closeFormDetail = function() {
                const detailCard = document.getElementById('form-detail-card');
                if (detailCard) {
                    detailCard.style.display = 'none';
                }
            };
            
            // 입력폼 삭제 함수
            window.deleteForm = async function(docId, submitterName) {
                if (!confirm(`정말로 ${submitterName || '이 입력폼'}을 삭제하시겠습니까?`)) {
                    return;
                }
                
                try {
                    await deleteDoc(doc(db, 'forms', docId));
                    alert('입력폼이 삭제되었습니다.');
                    loadFormList(); // 목록 새로고침
                } catch (error) {
                    console.error('입력폼 삭제 오류:', error);
                    alert('입력폼 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            };
            
            // 입력폼 상태 변경 함수
            window.changeFormStatus = async function(docId, newStatus) {
                try {
                    await updateDoc(doc(db, 'forms', docId), {
                        status: newStatus,
                        updatedAt: Timestamp.now()
                    });
                    
                    const statusText = newStatus === 'pending' ? '대기' : '완료';
                    console.log(`입력폼 상태가 "${statusText}"로 변경되었습니다.`);
                    
                    // 목록 새로고침
                    loadFormList();
                } catch (error) {
                    console.error('상태 변경 오류:', error);
                    alert('상태 변경 중 오류가 발생했습니다: ' + error.message);
                    // 오류 발생 시 목록 새로고침하여 원래 상태로 복구
                    loadFormList();
                }
            };
            
            // 전역 함수로 등록
            window.loadFormList = loadFormList;
            
            // 공지사항 목록 로드 함수
            async function loadNoticeList() {
                try {
                    const tbody = document.getElementById('notice-list-tbody');
                    if (!tbody) return;
                    
                    // 로딩 표시
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">로딩 중...</td></tr>';
                    
                    // Firestore에서 공지사항 목록 가져오기
                    const noticesRef = collection(db, 'notices');
                    const q = query(noticesRef, orderBy('createdAt', 'desc'));
                    const querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center">등록된 공지사항이 없습니다.</td></tr>';
                        return;
                    }
                    
                    // 테이블 데이터 생성
                    let html = '';
                    let index = 1;
                    const notices = [];
                    
                    querySnapshot.forEach((docSnapshot) => {
                        const noticeData = docSnapshot.data();
                        notices.push({
                            id: docSnapshot.id,
                            data: noticeData
                        });
                    });
                    
                    // 중요 공지사항을 먼저 정렬
                    notices.sort((a, b) => {
                        const aImportant = a.data.isImportant === true;
                        const bImportant = b.data.isImportant === true;
                        if (aImportant && !bImportant) return -1;
                        if (!aImportant && bImportant) return 1;
                        return 0;
                    });
                    
                    notices.forEach((notice) => {
                        const noticeData = notice.data;
                        const docId = notice.id;
                        
                        // 날짜 포맷팅
                        let createdAt = 'N/A';
                        if (noticeData.createdAt) {
                            const date = noticeData.createdAt.toDate ? noticeData.createdAt.toDate() : new Date(noticeData.createdAt);
                            createdAt = date.toLocaleDateString('ko-KR', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });
                        }
                        
                        // 상태 배지
                        const published = noticeData.published !== false;
                        const statusBadge = published 
                            ? '<span class="badge bg-success">공개</span>'
                            : '<span class="badge bg-secondary">비공개</span>';
                        
                        // 중요 공지 표시
                        const isImportant = noticeData.isImportant === true;
                        const titleDisplay = isImportant 
                            ? `<span class="badge bg-danger me-2">중요</span>${noticeData.title || 'N/A'}`
                            : (noticeData.title || 'N/A');
                        
                        html += `
                            <tr>
                                <th scope="row">${index}</th>
                                <td>${titleDisplay}</td>
                                <td>${noticeData.author || '관리자'}</td>
                                <td>${createdAt}</td>
                                <td>${noticeData.views || 0}</td>
                                <td>${statusBadge}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-2" onclick="editNotice('${docId}')">수정</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteNotice('${docId}', '${(noticeData.title || '').replace(/'/g, "&#39;")}')">삭제</button>
                                </td>
                            </tr>
                        `;
                        index++;
                    });
                    
                    tbody.innerHTML = html;
                } catch (error) {
                    console.error('공지사항 목록 로드 오류:', error);
                    const tbody = document.getElementById('notice-list-tbody');
                    if (tbody) {
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">데이터를 불러오는 중 오류가 발생했습니다.</td></tr>';
                    }
                }
            }
            
            // 공지사항 작성 폼 표시
            window.showNoticeForm = function() {
                const noticeListSection = document.getElementById('notice-list-section');
                const noticeAddSection = document.getElementById('notice-add-section');
                if (noticeListSection) noticeListSection.style.display = 'none';
                if (noticeAddSection) noticeAddSection.style.display = 'block';
                document.querySelector('.fs-18.fw-semibold').textContent = '공지사항 작성';
            };
            
            // 공지사항 목록 표시
            window.showNoticeList = function() {
                const noticeListSection = document.getElementById('notice-list-section');
                const noticeAddSection = document.getElementById('notice-add-section');
                if (noticeListSection) noticeListSection.style.display = 'block';
                if (noticeAddSection) noticeAddSection.style.display = 'none';
                document.querySelector('.fs-18.fw-semibold').textContent = '공지사항 관리';
                if (typeof window.loadNoticeList === 'function') {
                    setTimeout(() => {
                        window.loadNoticeList();
                    }, 100);
                }
            };
            
            // 공지사항 폼 초기화
            window.resetNoticeForm = function() {
                document.getElementById('notice-form').reset();
                document.getElementById('notice-published').checked = true;
            };
            
            // 공지사항 작성 함수
            async function submitNotice() {
                const form = document.getElementById('notice-form');
                const title = document.getElementById('notice-title').value.trim();
                const content = document.getElementById('notice-content').value.trim();
                const isImportant = document.getElementById('notice-important').checked;
                const published = document.getElementById('notice-published').checked;
                
                if (!title) {
                    alert('제목을 입력해주세요.');
                    return;
                }
                
                if (!content) {
                    alert('내용을 입력해주세요.');
                    return;
                }
                
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-light fa-spinner fa-spin"></i> 작성 중...';
                
                try {
                    // 현재 사용자 정보 가져오기
                    const currentUser = auth.currentUser;
                    const author = currentUser?.displayName || currentUser?.email || '관리자';
                    
                    await addDoc(collection(db, 'notices'), {
                        title: title,
                        content: content,
                        author: author,
                        isImportant: isImportant || false,
                        published: published !== false, // 명시적으로 boolean으로 저장
                        views: 0,
                        createdAt: Timestamp.now(),
                        updatedAt: Timestamp.now()
                    });
                    
                    alert('공지사항이 작성되었습니다.');
                    form.reset();
                    document.getElementById('notice-published').checked = true;
                    showNoticeList();
                } catch (error) {
                    console.error('공지사항 작성 오류:', error);
                    alert('공지사항 작성 중 오류가 발생했습니다: ' + error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            }
            
            // 공지사항 수정 함수 (추후 구현)
            window.editNotice = function(docId) {
                alert('공지사항 수정 기능은 추후 구현 예정입니다.');
            };
            
            // 공지사항 삭제 함수
            window.deleteNotice = async function(docId, title) {
                if (!confirm(`정말로 "${title || '이 공지사항'}"을 삭제하시겠습니까?`)) {
                    return;
                }
                
                try {
                    await deleteDoc(doc(db, 'notices', docId));
                    alert('공지사항이 삭제되었습니다.');
                    loadNoticeList();
                } catch (error) {
                    console.error('공지사항 삭제 오류:', error);
                    alert('공지사항 삭제 중 오류가 발생했습니다: ' + error.message);
                }
            };
            
            // 공지사항 폼 제출 이벤트
            const noticeForm = document.getElementById('notice-form');
            if (noticeForm) {
                noticeForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    submitNotice();
                });
            }
            
            // 전역 함수로 등록
            window.loadNoticeList = loadNoticeList;
            
            // 페이지 로드 시에도 실행
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    setTimeout(loadMemberList, 500);
                    setTimeout(loadFormList, 500);
                    setTimeout(loadNoticeList, 500);
                });
            } else {
                setTimeout(loadMemberList, 500);
                setTimeout(loadFormList, 500);
                setTimeout(loadNoticeList, 500);
            }
        </script>

        <!-- Sidebar 메뉴 클릭 시 섹션 전환 -->
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Sidebar 메뉴 클릭 이벤트
                const menuLinks = document.querySelectorAll('#side-menu .tp-link');
                menuLinks.forEach(link => {
                    link.addEventListener('click', function(e) {
                        e.preventDefault();
                        const targetId = this.getAttribute('href');
                        
                        // 모든 섹션 숨기기
                        document.querySelectorAll('.content-section').forEach(section => {
                            section.style.display = 'none';
                        });
                        
                        // 선택한 섹션 보이기
                        if (targetId === '#member-list') {
                            const memberSection = document.getElementById('member-list-section');
                            if (memberSection) {
                                memberSection.style.display = 'block';
                                // 회원 목록 새로고침
                                if (typeof window.loadMemberList === 'function') {
                                    setTimeout(() => {
                                        window.loadMemberList();
                                    }, 100);
                                }
                            }
                            document.querySelector('.fs-18.fw-semibold').textContent = '회원관리';
                        } else if (targetId === '#form-list') {
                            const formSection = document.getElementById('form-list-section');
                            if (formSection) {
                                formSection.style.display = 'block';
                                // 입력폼 목록 새로고침
                                if (typeof window.loadFormList === 'function') {
                                    setTimeout(() => {
                                        window.loadFormList();
                                    }, 100);
                                }
                            }
                            document.querySelector('.fs-18.fw-semibold').textContent = '입력폼관리';
                        } else if (targetId === '#notice-list') {
                            const noticeSection = document.getElementById('notice-list-section');
                            if (noticeSection) {
                                noticeSection.style.display = 'block';
                                // 공지사항 목록 새로고침
                                if (typeof window.loadNoticeList === 'function') {
                                    setTimeout(() => {
                                        window.loadNoticeList();
                                    }, 100);
                                }
                            }
                            document.querySelector('.fs-18.fw-semibold').textContent = '공지사항 관리';
                        } else if (targetId === '#notice-add') {
                            const noticeAddSection = document.getElementById('notice-add-section');
                            if (noticeAddSection) {
                                noticeAddSection.style.display = 'block';
                            }
                            document.querySelector('.fs-18.fw-semibold').textContent = '공지사항 작성';
                        }
                        
                        // 활성 메뉴 표시
                        menuLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                    });
                });
                
                // 검색 기능 구현
                const searchInput = document.getElementById('admin-search-input');
                const searchForm = document.getElementById('admin-search-form');
                
                if (searchInput) {
                    // 검색 입력 이벤트 (실시간 검색)
                    searchInput.addEventListener('input', function() {
                        performSearch(this.value.trim());
                    });
                    
                    // 폼 제출 방지
                    if (searchForm) {
                        searchForm.addEventListener('submit', function(e) {
                            e.preventDefault();
                            performSearch(searchInput.value.trim());
                        });
                    }
                }
                
                // 검색 함수
                function performSearch(searchTerm) {
                    // 현재 활성화된 섹션 확인
                    const activeSection = document.querySelector('.content-section[style*="block"], .content-section:not([style*="none"])');
                    
                    if (!activeSection) return;
                    
                    // 해당 섹션의 테이블 찾기
                    const table = activeSection.querySelector('table tbody');
                    if (!table) return;
                    
                    const rows = table.querySelectorAll('tr');
                    const searchLower = searchTerm.toLowerCase();
                    
                    if (searchTerm === '') {
                        // 검색어가 없으면 모든 행 표시
                        rows.forEach(row => {
                            row.style.display = '';
                        });
                        return;
                    }
                    
                    // 각 행 검색
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td, th');
                        let found = false;
                        
                        cells.forEach(cell => {
                            const text = cell.textContent.toLowerCase();
                            if (text.includes(searchLower)) {
                                found = true;
                            }
                        });
                        
                        // 검색어가 포함된 행만 표시
                        row.style.display = found ? '' : 'none';
                    });
                }
            });
        </script>
        
    </body>
</html>

